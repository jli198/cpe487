# Lab 5: DAC Siren

Program the FPGA on the Nexys A7-100T board to generate a wailing audio siren using a 24-bit [digital-to-analog converter](https://en.wikipedia.org/wiki/Digital-to-analog_converter) (DAC) called Pmod I2S ([Inter-IC Sound](https://en.wikipedia.org/wiki/I%C2%B2S)) to the top six pins of the Pmod port JA (See Section 10 of the [Reference Manual](https://reference.digilentinc.com/_media/reference/programmable-logic/nexys-a7/nexys-a7_rm.pdf))

* Pmod I2S requires a [3.5-mm connector](https://en.wikipedia.org/wiki/Phone_connector_(audio)) for a headphone or speaker

* WARNING: the siren is loud

![i2s.png](https://github.com/kevinwlu/dsd/blob/master/Nexys-A7/Lab-5/i2s.png)

* The [Pmod I2S](https://reference.digilentinc.com/reference/pmod/pmodi2s/start) has been replaced with the [Pmod I2S2](https://store.digilentinc.com/pmod-i2s2-stereo-audio-input-and-output/): stereo audio input (blue) and output (green)
  > The Digilent Pmod I2S2 features a [Cirrus CS5343](https://www.cirrus.com/products/cs5343-44/) Multi-Bit Audio A/D Converter and
  > a Cirrus CS4344 Stereo D/A Converter, each connected to 3.5mm Audio Jacks.
  > These circuits allow a system board to transmit and receive stereo audio signals via the I2S protocol.
  > The Pmod I2S2 supports 24-bit resolution per channel at input sample rates up to 108 KHz.

![i2s2.jpg](https://github.com/kevinwlu/dsd/blob/master/Nexys-A7/Lab-5/i2s2.jpg)

* The **_dac_if_** module takes 16-bit parallel stereo data and converts it to the serial format required by the digital to analog converter.
  * When L_start is high, a 16-bit left channel data word  is loaded into the 16-bit serial shift register SREG on the falling edge of SCLK.
  * When L_start goes low, SCLK shifts the data out of SREG, MSBit first to the serial output SDATA at a rate of 1.56 Mb/s.
  * Simlarly, when R_start goes high, right channel data is loaded into SREG and then shifted out to SDATA.
  * Output data changes on the falling edge of SCLK, so that it is stable when the DAC is reading the data on the rising edge of SCLK.

* The **_tone_** module generates a signed triangular wave (a tone) at a sampling rate of 48.8 KHz.
  * [Online tone generator](https://onlinetonegenerator.com/)
  * [Scale (music)](https://en.wikipedia.org/wiki/Scale_(music))
  * [A Brief Introduction to the Western Musical Scale](https://inst.eecs.berkeley.edu/~ee20/sp97/demos/lec2/music.html)
  * The frequency of the tone is determined by the input [pitch](https://en.wikipedia.org/wiki/Pitch_(music)).
  * The process cnt_pr generates an unsigned sawtooth waveform count by incrementing a 16-bit counter pitch values every clock cycle.
  * The frequency with which it traverses the whole 16-bit count range is thus proportional to pitch.
  * The lowest possible tone frequency is obtained when pitch=1.
  * It then takes 2<sup>16</sup> or 65,536 cycles to traverse the range of the counter.
  * The frequency is then 48.8kHz / 216 or 0.745 Hz.
  * If pitch is set to 1000, the frequency would be 1000 x 0.745 Hz or 745 Hz.
  * A select signal assignment statement is then used to convert the unsigned sawtooth count into a signed triangle wave.
  * The sawtooth count is split up into 4 quadrants quad and an index value within the quadrant.
  * The signals quad and index are used to generate a triangle wave.

![wave.png](https://github.com/kevinwlu/dsd/blob/master/Nexys-A7/Lab-5/wave.png)

* The **_wail_** module creates an instance of the module tone and then modulates the pitch up and down to produce a “wailing” siren
  * The inputs hi_pitch and lo_pitch define the upper and lower limits of the generated tone.
  * The inputs wspeed and wclk determine how fast the pitch changes.
  * The wailing tone is generated by the process wp.
  * This process is run on the rising edge of wclk.
  * This is a slow clock (approx. 48 Hz)
  * Every wclk cycle, the current pitch is raised or lowered depending on the value of updn.
  * When updn=’1’, the pitch rises. When updn=’0’, the pitch lowers.
  * The input wspeed determines how much the pitch changes every wclk cycle.
  * When the current pitch exceeds hi_pitch, updn is set to ‘0’ so that the pitch will start decreasing.
  * Similarly, when the current pitch is lower than lo_pitch, updn is set to ‘1’ to start the tone rising again.

* The **_siren_** module is the top level.
  * The constants lo_tone, hi_tone, and wail_speed define the parameters of the siren.
  * The 20-bit timing counter tcount is used to generate all the necessary timing signals.
  * The module wail is instanced to generate the 16-bit signed audio sequences data_L and data_R (the same data is sent to both channels).
  * These sequences are then sent to an instance of dac_if to convert them to the required serial stream.
  * Primary outputs of this top level module go directly to the DAC.

### 1. Create a new RTL project _siren_ in Vivado Quick Start

* Create four new source files of file type VHDL called **_dac_if_**, **_tone_**, **_wail_**, and **_siren_**

* Create a new constraint file of file type XDC called **_siren_**

* Choose Nexys A7-100T board for the project

* Click 'Finish'

* Click design sources and copy the VHDL code from dac_if.vhd, tone.vhd, wail.vhd, siren.vhd

* Click constraints and copy the code from siren.xdc

### 2. Run synthesis

### 3. Run implementation and open implemented design

### 4. Generate bitstream, open hardware manager, and program device

* Click 'Generate Bitstream'

* Click 'Open Hardware Manager' and click 'Open Target' then 'Auto Connect'

* Click 'Program Device' then xc7a100t_0 to download siren.bit to the Nexys A7-100T board

### 5. Edit code with the following modifications

#### A) Incorporate a square wave

* Modify the tone module to create a square wave instead of a triangle wave when the upper push button (BTNU) is depressed

* Add this push button as an input to siren.vhd and pass its value down to the tone module

* Get the correct pin number for this push button from the Reference Manual

* Note the difference in the quality of the tone when switching to a square wave tone

#### B) Change the wailing speed

* Use the eight slide switches (SW0-SW7) on the Nexys A7-100T board to set the wailing speed

* Add these as inputs to siren.vhd

* Get the correct pin numbers for these switches from the Reference Manual

#### C) Add a second wail instance to drive the right audio channel

* Use different high and low tone limits and wailing speed for the right audio channel

* Note: you will need headphones or another wired device with left and right audio output channels to hear both channels at once. If you do not have immediate access to such a device, modify your code to include a button press that toggles the primary output between the left and right audio channels in some way.

## Grade: 95/100
